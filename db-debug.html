<!DOCTYPE html>
<html>
<head>
    <title>DB Debug Test</title>
</head>
<body>
    <h1>Database Debug Test</h1>
    <div id="results"></div>

    <script src="assets/main.js"></script>
    <script>
        const results = document.getElementById('results');

        function log(message, isError = false) {
            const div = document.createElement('div');
            div.style.color = isError ? 'red' : 'black';
            div.style.margin = '5px 0';
            div.textContent = message;
            results.appendChild(div);
            console.log(message);
        }

        async function testDatabase() {
            try {
                log('🔍 Starting comprehensive database test...');

                // Test environment variables
                const supabaseUrl = window.location.hostname === 'localhost'
                    ? 'https://xtpfssiraytzvdvgrsol.supabase.co'
                    : ENV_CONFIG.VITE_SUPABASE_URL || 'https://xtpfssiraytzvdvgrsol.supabase.co';

                const supabaseKey = window.location.hostname === 'localhost'
                    ? 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0cGZzc2lyYXl0enZkdmdyc29sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjU0NTUyOTMsImV4cCI6MjA0MTAzMTI5M30.vJJwF7sSjULnxKmJJZNpZu4yXUQnZvFWJgGGp_TGqMI'
                    : ENV_CONFIG.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0cGZzc2lyYXl0enZkdmdyc29sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjU0NTUyOTMsImV4cCI6MjA0MTAzMTI5M30.vJJwF7sSjULnxKmJJZNpZu4yXUQnZvFWJgGGp_TGqMI';

                log(`📡 Supabase URL: ${supabaseUrl}`);
                log(`🔑 Supabase Key: ${supabaseKey.substring(0, 20)}...`);

                // Create Supabase client
                const { createClient } = supabase;
                const client = createClient(supabaseUrl, supabaseKey);
                log('✅ Supabase client created');

                // Test 1: Simple connection
                log('\n🔄 Test 1: Testing basic connection...');
                try {
                    const { data: healthCheck, error: healthError } = await client
                        .from('profiles')
                        .select('id')
                        .limit(1);

                    if (healthError) {
                        log(`❌ Connection test failed: ${healthError.message}`, true);
                        log(`❌ Error details: ${JSON.stringify(healthError)}`, true);
                    } else {
                        log(`✅ Connection successful! Found ${healthCheck?.length || 0} profiles`);
                    }
                } catch (connError) {
                    log(`❌ Connection exception: ${connError.message}`, true);
                }

                // Test 2: Test specific score write (simulate game)
                log('\n🔄 Test 2: Testing score submission (anonymous)...');
                try {
                    const { data: scoreData, error: scoreError } = await client
                        .from('scores')
                        .insert({
                            user_id: '00000000-0000-0000-0000-000000000000', // test UUID
                            score: 99,
                            run_seconds: 30
                        })
                        .select()
                        .single();

                    if (scoreError) {
                        log(`❌ Score write failed: ${scoreError.message}`, true);
                        log(`❌ Score error code: ${scoreError.code}`, true);
                        log(`❌ Score error details: ${JSON.stringify(scoreError)}`, true);
                    } else {
                        log('✅ Score write successful!');
                        log(`✅ Score data: ${JSON.stringify(scoreData)}`);
                    }
                } catch (scoreException) {
                    log(`❌ Score write exception: ${scoreException.message}`, true);
                }

                // Test 3: Test leaderboard read
                log('\n🔄 Test 3: Testing leaderboard read...');
                try {
                    const threeDaysAgo = new Date();
                    threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);

                    const { data: leaderData, error: leaderError } = await client
                        .from('scores')
                        .select('*')
                        .gte('created_at', threeDaysAgo.toISOString())
                        .order('score', { ascending: false })
                        .limit(5);

                    if (leaderError) {
                        log(`❌ Leaderboard read failed: ${leaderError.message}`, true);
                        log(`❌ Leaderboard error details: ${JSON.stringify(leaderError)}`, true);
                    } else {
                        log(`✅ Leaderboard read successful! Found ${leaderData?.length || 0} scores`);
                        if (leaderData && leaderData.length > 0) {
                            log(`✅ Sample scores: ${JSON.stringify(leaderData.slice(0, 2))}`);
                        }
                    }
                } catch (leaderException) {
                    log(`❌ Leaderboard exception: ${leaderException.message}`, true);
                }

                // Test 4: Auth status
                log('\n🔄 Test 4: Testing auth status...');
                try {
                    const { data: authData, error: authError } = await client.auth.getSession();

                    if (authError) {
                        log(`❌ Auth check failed: ${authError.message}`, true);
                    } else {
                        const isAuthenticated = !!authData?.session?.user;
                        log(`🔐 Authentication status: ${isAuthenticated ? 'AUTHENTICATED' : 'ANONYMOUS'}`);
                        if (isAuthenticated) {
                            log(`👤 User: ${authData.session.user.email}`);
                        }
                    }
                } catch (authException) {
                    log(`❌ Auth exception: ${authException.message}`, true);
                }

                log('\n🏁 Database test completed!');

            } catch (generalError) {
                log(`💥 General test error: ${generalError.message}`, true);
            }
        }

        // Start tests when page loads
        setTimeout(testDatabase, 1000);
    </script>
</body>
</html>