<!DOCTYPE html>
<html>
<head>
    <title>RLS Test</title>
</head>
<body>
    <h1>RLS Policy Test</h1>
    <div id="results"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const results = document.getElementById('results');

        function log(message, isError = false) {
            const div = document.createElement('div');
            div.style.color = isError ? 'red' : 'black';
            div.style.margin = '5px 0';
            div.textContent = message;
            results.appendChild(div);
            console.log(message);
        }

        async function testRLS() {
            try {
                log('🔍 Testing RLS Policies...');

                // Create Supabase client
                const { createClient } = supabase;
                const client = createClient(
                    'https://xtpfssiraytzvdvgrsol.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0cGZzc2lyYXl0enZkdmdyc29sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjU0NTUyOTMsImV4cCI6MjA0MTAzMTI5M30.vJJwF7sSjULnxKmJJZNpZu4yXUQnZvFWJgGGp_TGqMI'
                );

                log('✅ Client created');

                // Test 1: Try to read scores (should work - RLS allows public read)
                log('\n🔄 Test 1: Reading scores (should work)...');
                const startTime1 = Date.now();

                const { data: scores, error: scoreError } = await Promise.race([
                    client.from('scores').select('*').limit(5),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Read timeout')), 5000))
                ]);

                const elapsed1 = Date.now() - startTime1;

                if (scoreError) {
                    log(`❌ Score read failed after ${elapsed1}ms: ${scoreError.message}`, true);
                    log(`❌ Error code: ${scoreError.code}`, true);
                } else {
                    log(`✅ Score read successful after ${elapsed1}ms! Found ${scores.length} scores`);
                }

                // Test 2: Try to write score (should fail - no authentication)
                log('\n🔄 Test 2: Writing score without auth (should fail fast)...');
                const startTime2 = Date.now();

                const { data: writeData, error: writeError } = await Promise.race([
                    client.from('scores').insert({
                        user_id: '00000000-0000-0000-0000-000000000000',
                        score: 999,
                        run_seconds: 60
                    }),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Write timeout')), 5000))
                ]);

                const elapsed2 = Date.now() - startTime2;

                if (writeError) {
                    log(`✅ Score write correctly failed after ${elapsed2}ms: ${writeError.message}`);
                    log(`✅ Error code: ${writeError.code}`);
                } else {
                    log(`❌ Score write should have failed but succeeded after ${elapsed2}ms!`, true);
                }

                // Test 3: Check auth status
                log('\n🔄 Test 3: Checking auth status...');
                const { data: { session }, error: authError } = await client.auth.getSession();

                if (authError) {
                    log(`❌ Auth check failed: ${authError.message}`, true);
                } else {
                    const isAuth = !!session?.user;
                    log(`🔐 Auth status: ${isAuth ? 'AUTHENTICATED' : 'ANONYMOUS'}`);
                    if (isAuth) {
                        log(`👤 User: ${session.user.email}`);
                    }
                }

                log('\n🏁 RLS test completed!');

            } catch (error) {
                log(`💥 Test error: ${error.message}`, true);
            }
        }

        // Start test
        setTimeout(testRLS, 1000);
    </script>
</body>
</html>